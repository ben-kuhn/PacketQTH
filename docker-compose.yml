version: '3.8'

services:
  packetqth:
    build: .
    container_name: packetqth
    image: packetqth:latest
    restart: unless-stopped
    
    ports:
      - "127.0.0.1:8023:8023"
    
    volumes:
      # Mount configuration files as read-only
      - ./config.yaml:/app/config.yaml:ro
      - ./users.yaml:/app/users.yaml:ro
      # Mount logs directory for persistence
      - ./logs:/app/logs
    
    environment:
      # HomeAssistant token - can be set via .env file
      - HA_TOKEN=${HA_TOKEN}
      # Optional: Set log level
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    
    networks:
      - homeassistant
    
    # Security hardening
    security_opt:
      - no-new-privileges:true
    
    cap_drop:
      - ALL
    
    # Read-only filesystem except for /tmp and /app/logs
    read_only: true
    tmpfs:
      - /tmp
    
    # Resource limits (optional, adjust as needed)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

networks:
  homeassistant:
    # Use existing HomeAssistant network if it exists
    # or create a new one
    external: false
    driver: bridge
